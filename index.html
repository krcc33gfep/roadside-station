<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>道の駅ビューワー（修正版・完全動作版）</title>

<link href="https://fonts.googleapis.com/css2?family=M+PLUS+1+Code:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
html, body {
  background: #f0fff4;
  color: #033;
  font-family: "M PLUS 1 Code", monospace;
  margin: 0;
  overflow-x: hidden;
}
header {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 12px;
  background: #a5d6a7;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* ★検索エリア */
.search-wrapper {
  position: relative;
  width: 66%;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* ★追加 */
.search-wrapper input {
  padding-right: 36px;   /* ×マーク分の余白を確保 */
}

#resultCount {
  font-size: 20px;
  color: #1b5e20;
  white-space: nowrap;
}

input[type="text"] {
  width: 100%;
  background: #e8f5e9;
  border: 1px solid #81c784;
  border-radius: 8px;
  padding: 8px 36px 8px 10px;
  font-size: 16px;
  box-sizing: border-box;
}

.clear-btn {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: #388e3c;
  font-size: 20px;
  cursor: pointer;
  display: none;
}

.header-bottom {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  gap: 20px;
  margin-top: 8px;
}

.stats-box {
  font-size: 13px;
  line-height: 1.3;
  color: #1b5e20;
  white-space: nowrap;
}

.sort-buttons {
  display: flex;
  gap: 8px;
}

.sort-buttons button {
  background: #81c784;
  color: #033;
  border: none;
  border-radius: 6px;
  padding: 6px 12px;
  cursor: pointer;
  font-size: 16px;
  width: 100px;
}

/* ★CSVメニュー（元通り） */
.csv-menu {
  display: none;
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  background: #fff;
  border: 1px solid #81c784;
  border-radius: 8px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.25);
  overflow: hidden;
  min-width: 130px;
  margin-top: 6px;
  z-index: 10;
}
.csv-menu button {
  display: block;
  width: 100%;
  border: none;
  background: #fff;
  padding: 10px 16px;
  text-align: center;
  cursor: pointer;
}
.csv-menu button:hover {
  background: #c8e6c9;
}

.container { padding: 10px; }
.row {
  display: flex;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom: 1px solid #c8e6c9;
}
.left { flex: 2; }
.right { flex: 1; text-align: right; }
.name {
  font-size: 1.3em;
  font-weight: 600;
  color: #2e7d32;
  cursor: pointer;
}
.address { font-size: 0.9em; color: #555; }
.last-visit { font-size: 0.9em; color: #1b5e20; }
.ticket { font-size: 0.85em; color: #388e3c; }
  .search-box {
  position: relative;
  width: 100%;
}

</style>
</head>

<body>
<header>
<div class="search-wrapper">
  <div class="search-box">
    <input id="search" type="text">
    <button id="clearBtn" class="clear-btn">&times;</button>
  </div>
  <div id="resultCount"></div>
</div>

  <div class="header-bottom">
    <div class="sort-buttons">
      <button id="toggleVisited">全部</button>
      <div style="position:relative">
        <button id="csvMainBtn">保存</button>
        <div class="csv-menu" id="csvMenu">
          <button id="exportCSVBtn">エクスポート</button>
          <button id="importCSVBtn">インポート</button>
        </div>
      </div>
    </div>
    <div class="stats-box" id="statsBox">訪問：0<br>切符：0</div>
  </div>
</header>

<div class="container" id="output"></div>
<input type="file" id="csvFile" style="display:none">

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/1VOKUKRTHUnmj5ILDyqJbdbqkePLFps-Ti8UpUfjnHeg/gviz/tq?tqx=out:csv";
let rows=[], currentSearch="", viewMode=0;

fetch(csvUrl).then(r=>r.text()).then(t=>{
  Papa.parse(t,{header:true,skipEmptyLines:true,complete:r=>{rows=r.data;renderFiltered();}});
});

const search=document.getElementById("search");
const clearBtn=document.getElementById("clearBtn");

search.addEventListener("input",()=>{
  currentSearch=search.value.toLowerCase().trim();
  clearBtn.style.display=currentSearch?"block":"none";
  renderFiltered();
});
clearBtn.onclick=()=>{search.value="";currentSearch="";clearBtn.style.display="none";renderFiltered();};

document.getElementById("toggleVisited").onclick = () => {
  viewMode = viewMode ? 0 : 1;

  // 表示中の状態と逆の文言を出す
  document.getElementById("toggleVisited").textContent =
    viewMode === 0 ? "全部" : "訪問済";

  renderFiltered();
};

/* CSVメニュー開閉（元通り） */
const csvMainBtn=document.getElementById("csvMainBtn");
const csvMenu=document.getElementById("csvMenu");
csvMainBtn.onclick=e=>{
  e.stopPropagation();
  csvMenu.style.display=csvMenu.style.display==="block"?"none":"block";
};
document.addEventListener("click",()=>csvMenu.style.display="none");

function renderFiltered(){
  let filtered=rows.filter(r=>{
    const s=JSON.parse(localStorage.getItem(`michinoeki_${r.ID}`)||"{}");
    if(!viewMode && !(s.visits?.length)) return false;
    if(!currentSearch) return true;
    return currentSearch.split(/\s+/).some(k=>
      (r['名称']||"").toLowerCase().includes(k) ||
      (r['住所']||"").toLowerCase().includes(k)
    );
  });

  if(!viewMode){
    filtered.sort((a,b)=>{
      const sa=JSON.parse(localStorage.getItem(`michinoeki_${a.ID}`)||"{}");
      const sb=JSON.parse(localStorage.getItem(`michinoeki_${b.ID}`)||"{}");
      return new Date(sb.visits?.[0]?.date||0)-new Date(sa.visits?.[0]?.date||0);
    });
  }

  const out=document.getElementById("output");
  out.innerHTML="";
  filtered.forEach(r=>{
    const s=JSON.parse(localStorage.getItem(`michinoeki_${r.ID}`)||"{}");
    out.insertAdjacentHTML("beforeend",`
      <div class="row">
        <div class="left">
          <div class="name">${r['名称']}</div>
          <div class="address">${r['住所']||""}</div>
        </div>
        <div class="right">
          <div class="last-visit">${s.visits?.[0]?.date||""}</div>
          <div class="ticket">${s.ticket?"切符入手済":""}</div>
        </div>
      </div>
    `);
  });

  document.getElementById("resultCount").textContent=`${filtered.length}件`;
  updateStats();
}

function updateStats(){
  let v=0,t=0;
  for(let k in localStorage){
    if(k.startsWith("michinoeki_")){
      const s=JSON.parse(localStorage.getItem(k));
      if(s.visits?.length) v++;
      if(s.ticket) t++;
    }
  }
  document.getElementById("statsBox").innerHTML=`訪問：${v}<br>切符：${t}`;
}
</script>
</body>
</html>
