<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>é“ã®é§…ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ï¼ˆæ•´ç†ç‰ˆãƒ»å®Œå…¨å‹•ä½œï¼‰</title>

<link href="https://fonts.googleapis.com/css2?family=M+PLUS+1+Code:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
/* ===== ãƒ™ãƒ¼ã‚¹ ===== */
html, body{
  margin:0;
  background:#f0fff4;
  color:#033;
  font-family:"M PLUS 1 Code", monospace;
  overflow-x:hidden;
}

/* ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== */
header{
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:12px;
  background:#a5d6a7;
  box-shadow:0 2px 4px rgba(0,0,0,0.1);
}

.search-wrapper{
  position:relative;
  width:95%;
  max-width:500px;
}

input[type="text"]{
  width:100%;
  background:#e8f5e9;
  border:1px solid #81c784;
  border-radius:8px;
  padding:8px 36px 8px 10px;
  font-size:16px;
  box-sizing:border-box;
}

.clear-btn{
  position:absolute;
  right:8px;
  top:50%;
  transform:translateY(-50%);
  background:none;
  border:none;
  font-size:20px;
  color:#388e3c;
  cursor:pointer;
  display:none;
}

.header-bottom{
  display:flex;
  align-items:center;
  justify-content:center;
  width:100%;
  gap:20px;
  margin-top:8px;
}

.stats-box{
  font-size:13px;
  line-height:1.3;
  color:#1b5e20;
  white-space:nowrap;
}

/* ===== ãƒœã‚¿ãƒ³ ===== */
.sort-buttons{
  display:flex;
  gap:8px;
}

.sort-buttons button{
  background:#81c784;
  border:none;
  border-radius:6px;
  padding:6px 12px;
  font-size:16px;
  cursor:pointer;
}

.sort-buttons button.active{
  background:#4caf50;
  color:#fff;
}

/* ===== CSVãƒ¡ãƒ‹ãƒ¥ãƒ¼ ===== */
.csv-menu{
  display:none;
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  background:#fff;
  border:1px solid #81c784;
  border-radius:8px;
  box-shadow:0 3px 8px rgba(0,0,0,0.25);
  overflow:hidden;
  min-width:130px;
  margin-top:6px;
  z-index:10;
}

.csv-menu button{
  width:100%;
  padding:10px;
  border:none;
  background:#fff;
  cursor:pointer;
}

.csv-menu button:hover{
  background:#c8e6c9;
}

/* ===== ä¸€è¦§ ===== */
.container{ padding:10px; }

.row{
  display:flex;
  justify-content:space-between;
  padding:10px 0;
  border-bottom:1px solid #c8e6c9;
}

.left{
  flex:2;
  overflow:hidden;
}

.name{
  font-size:1.3em;
  font-weight:600;
  color:#2e7d32;
  cursor:pointer;
}

.address{
  font-size:0.9em;
  color:#555;
}

.right{
  flex:1;
  text-align:right;
}

.last-visit{ font-size:0.9em; }
.ticket{ font-size:0.85em; color:#388e3c; }

/* ===== ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.4);
  justify-content:center;
  align-items:center;
  z-index:999;
}

.modal-content{
  background:#fff;
  padding:20px;
  border-radius:10px;
  width:70%;
  max-width:800px;
  max-height:90%;
  overflow-y:auto;
}

.visit-entry{
  display:flex;
  justify-content:space-between;
  padding:4px 0;
  border-bottom:1px solid #ddd;
}

.delete-btn{
  border:none;
  background:none;
  color:#d32f2f;
  cursor:pointer;
}

#visitList{
  max-height:calc(3 * 34px);
  overflow-y:auto;
  margin-top:8px;
}
</style>
</head>

<body>
<header>
  <div class="search-wrapper">
    <input id="search" type="text" placeholder="æ¤œç´¢ï¼ˆåç§°ãƒ»ä½æ‰€ï¼‰...">
    <button id="clearBtn" class="clear-btn">&times;</button>
  </div>

  <div class="header-bottom">
    <div class="sort-buttons">
      <button id="sortVisitDate">è¨ªå•</button>
      <button id="filterTicket">åˆ‡ç¬¦</button>
      <div style="position:relative;">
        <button id="csvMainBtn">ä¿å­˜</button>
        <div class="csv-menu" id="csvMenu">
          <button id="exportCSVBtn">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <button id="importCSVBtn">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        </div>
      </div>
    </div>
    <div class="stats-box" id="statsBox">è¨ªå•ï¼š0<br>åˆ‡ç¬¦ï¼š0</div>
  </div>
</header>

<div class="container" id="output"></div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal" id="detailModal">
  <div class="modal-content">
    <h2 id="modalName"></h2>
    åˆ‡ç¬¦è³¼å…¥ï¼š<input type="checkbox" id="ticketCheck">
    <div>è¨ªå•å±¥æ­´<span id="visitCountLabel"></span></div>
    <div id="visitList"></div>
    <input type="date" id="visitDate">
    <div>
      <button id="addVisitBtn">è¿½åŠ </button>
      <button id="closeModal2">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<input type="file" id="csvFile" style="display:none">

<script>
/* ===== å…±é€š ===== */
const $ = id => document.getElementById(id);
const STORAGE = id => `michinoeki_${id}`;
const csvUrl = "https://docs.google.com/spreadsheets/d/1VOKUKRTHUnmj5ILDyqJbdbqkePLFps-Ti8UpUfjnHeg/gviz/tq?tqx=out:csv";

let rows=[], currentId=null, currentSearch="";
let showOnlyTicket=false, sortByVisitDate=false;

/* ===== CSVèª­ã¿è¾¼ã¿ ===== */
fetch(csvUrl).then(r=>r.text()).then(text=>{
  Papa.parse(text,{
    header:true,
    skipEmptyLines:true,
    complete:res=>{
      rows=res.data;
      render();
    }
  });
});

/* ===== æ¤œç´¢ ===== */
$("search").addEventListener("input",()=>{
  currentSearch=$("search").value.toLowerCase().trim();
  $("clearBtn").style.display=currentSearch?"block":"none";
  render();
});
$("clearBtn").onclick=()=>{
  $("search").value="";
  currentSearch="";
  $("clearBtn").style.display="none";
  render();
};

/* ===== ãƒ•ã‚£ãƒ«ã‚¿ãƒ»ã‚½ãƒ¼ãƒˆ ===== */
$("filterTicket").onclick=()=>{
  showOnlyTicket=!showOnlyTicket;
  $("filterTicket").classList.toggle("active",showOnlyTicket);
  render();
};
$("sortVisitDate").onclick=()=>{
  sortByVisitDate=!sortByVisitDate;
  $("sortVisitDate").classList.toggle("active",sortByVisitDate);
  render();
};

/* ===== CSVãƒ¡ãƒ‹ãƒ¥ãƒ¼ ===== */
$("csvMainBtn").onclick=e=>{
  e.stopPropagation();
  $("csvMenu").style.display=$("csvMenu").style.display==="block"?"none":"block";
};
document.addEventListener("click",()=>$("csvMenu").style.display="none");

/* ===== æç”» ===== */
function render(){
  const out=$("output");
  out.innerHTML="";
  let list=rows.filter(r=>{
    const saved=JSON.parse(localStorage.getItem(STORAGE(r.ID))||"{}");
    if(showOnlyTicket && !saved.ticket) return false;
    if(!currentSearch) return true;
    return currentSearch.split(/\s+/).some(k=>
      (r.åç§°||"").toLowerCase().includes(k) ||
      (r.ä½æ‰€||"").toLowerCase().includes(k)
    );
  });

  if(sortByVisitDate){
    list.sort((a,b)=>{
      const A=JSON.parse(localStorage.getItem(STORAGE(a.ID))||"{}").visits?.[0]?.date||0;
      const B=JSON.parse(localStorage.getItem(STORAGE(b.ID))||"{}").visits?.[0]?.date||0;
      return new Date(B)-new Date(A);
    });
  }

  list.forEach(r=>{
    const saved=JSON.parse(localStorage.getItem(STORAGE(r.ID))||"{}");
    const visits=saved.visits||[];
    const div=document.createElement("div");
    div.className="row";
    div.innerHTML=`
      <div class="left">
        <div class="name">${r.åç§°||""}</div>
        <div class="address">${r.ä½æ‰€||""}</div>
      </div>
      <div class="right">
        <div class="last-visit">${visits.length?`${visits.length}å› ${visits[0].date}`:""}</div>
        <div class="ticket">${saved.ticket?"åˆ‡ç¬¦è³¼å…¥æ¸ˆ":""}</div>
      </div>`;
    div.querySelector(".name").onclick=()=>openDetail(r);
    out.appendChild(div);
  });
  updateStats();
}

/* ===== çµ±è¨ˆ ===== */
function updateStats(){
  let v=0,t=0;
  Object.keys(localStorage).forEach(k=>{
    if(k.startsWith("michinoeki_")){
      const s=JSON.parse(localStorage.getItem(k)||"{}");
      if(s.visits?.length) v++;
      if(s.ticket) t++;
    }
  });
  $("statsBox").innerHTML=`è¨ªå•ï¼š${v}<br>åˆ‡ç¬¦ï¼š${t}`;
}

/* ===== ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
$("closeModal2").onclick=()=>$("detailModal").style.display="none";

function openDetail(r){
  currentId=r.ID;
  $("detailModal").style.display="flex";
  $("modalName").textContent=r.åç§°;
  $("visitDate").value=new Date().toISOString().split("T")[0];
  const saved=JSON.parse(localStorage.getItem(STORAGE(currentId))||'{"visits":[],"ticket":false}');
  $("ticketCheck").checked=saved.ticket;
  renderVisits(saved.visits);
}

$("ticketCheck").onchange=e=>{
  const saved=JSON.parse(localStorage.getItem(STORAGE(currentId))||'{"visits":[],"ticket":false}');
  saved.ticket=e.target.checked;
  localStorage.setItem(STORAGE(currentId),JSON.stringify(saved));
  render();
};

$("addVisitBtn").onclick=()=>{
  const date=$("visitDate").value;
  if(!date) return alert("è¨ªå•æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  const saved=JSON.parse(localStorage.getItem(STORAGE(currentId))||'{"visits":[],"ticket":false}');
  saved.visits.push({date});
  saved.visits.sort((a,b)=>new Date(b.date)-new Date(a.date));
  localStorage.setItem(STORAGE(currentId),JSON.stringify(saved));
  renderVisits(saved.visits);
  render();
};

function deleteVisit(i){
  const saved=JSON.parse(localStorage.getItem(STORAGE(currentId)));
  saved.visits.splice(i,1);
  localStorage.setItem(STORAGE(currentId),JSON.stringify(saved));
  renderVisits(saved.visits);
  render();
}

function renderVisits(visits){
  const list=$("visitList");
  const label=$("visitCountLabel");
  list.innerHTML="";
  if(!visits.length){ label.textContent="ï¼š0å›"; return; }
  visits.forEach((v,i)=>{
    const div=document.createElement("div");
    div.className="visit-entry";
    div.innerHTML=`<div>${v.date}</div>`;
    const b=document.createElement("button");
    b.textContent="ğŸ—‘";
    b.className="delete-btn";
    b.onclick=()=>deleteVisit(i);
    div.appendChild(b);
    list.appendChild(div);
  });
  label.textContent=`ï¼š${visits.length}å›`;
}
</script>
</body>
</html>
