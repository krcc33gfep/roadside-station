<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>é“ã®é§…ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ï¼ˆä¿®æ­£ç‰ˆãƒ»å®Œå…¨å‹•ä½œç‰ˆï¼‰</title>

<link href="https://fonts.googleapis.com/css2?family=M+PLUS+1+Code:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
html,body{
  margin:0;
  background:#f0fff4;
  color:#033;
  font-family:"M PLUS 1 Code",monospace;
  overflow-x:hidden;
}

/* ===== ãƒ˜ãƒƒãƒ€ãƒ¼å…¨ä½“ ===== */
header{
  display:flex;
  justify-content:center;
  background:#a5d6a7;
  box-shadow:0 2px 4px rgba(0,0,0,.1);
  padding:12px 0;
}

.header-inner{
  display:flex;
  width:90vw;
  max-width:1200px;
}

/* ===== å·¦ã‚«ãƒ©ãƒ  ===== */
.header-left{
  width:70%;
  display:flex;
  flex-direction:column;
  align-items:flex-end; /* å³å¯„ã› */
  gap:10px;
}

/* æ¤œç´¢ */
.search-wrapper{
  width:100%;
  max-width:600px;
  display:flex;
  align-items:center;
}

.search-input-wrapper{
  position:relative;
  flex:1;
}

input[type="text"]{
  width:100%;
  background:#e8f5e9;
  border:1px solid #81c784;
  border-radius:8px;
  padding:8px 36px 8px 10px;
  font-size:16px;
}

.clear-btn{
  position:absolute;
  right:8px;
  top:50%;
  transform:translateY(-50%);
  background:none;
  border:none;
  font-size:20px;
  color:#388e3c;
  cursor:pointer;
  display:none;
}

/* ã‚½ãƒ¼ãƒˆãƒ»ä¿å­˜ */
.sort-buttons{
  display:flex;
  gap:8px;
}

.sort-buttons button{
  background:#81c784;
  border:none;
  border-radius:6px;
  padding:6px 30px;
  font-size:16px;
  cursor:pointer;
}

.sort-buttons button.active{
  background:#4caf50;
  color:#fff;
}

/* ===== å³ã‚«ãƒ©ãƒ  ===== */
.header-right{
  width:30%;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:flex-start; /* å·¦å¯„ã› */
  font-size:15px;
  color:#1b5e20;
  line-height:1.4;
  padding-left:16px;
}

/* ===== CSVãƒ¡ãƒ‹ãƒ¥ãƒ¼ ===== */
.csv-menu{
  display:none;
  position:absolute;
  background:#fff;
  border:1px solid #81c784;
  border-radius:8px;
  box-shadow:0 3px 8px rgba(0,0,0,.25);
  z-index:10;
}

.csv-menu button{
  width:100%;
  border:none;
  background:#fff;
  padding:10px;
  cursor:pointer;
}

.csv-menu button:hover{background:#c8e6c9}

/* ===== ä¸€è¦§ ===== */
.container{padding:10px}

.row{
  display:grid;
  grid-template-columns:1fr auto;
  grid-template-rows:auto auto;
  column-gap:12px;
  padding:10px 0;
  border-bottom:1px solid #c8e6c9;
}

.name{
  font-size:1.3em;
  font-weight:600;
  color:#2e7d32;
  cursor:pointer;
}

.address{
  font-size:.9em;
  color:#555;
}

.last-visit,.ticket{
  text-align:right;
  font-size:.9em;
}
</style>
</head>

<body>

<header>
  <div class="header-inner">

    <!-- å·¦ -->
    <div class="header-left">
      <div class="search-wrapper">
        <div class="search-input-wrapper">
          <input id="search" type="text" placeholder="æ¤œç´¢ï¼ˆåç§°ãƒ»ä½æ‰€ï¼‰...">
          <button id="clearBtn" class="clear-btn">&times;</button>
        </div>
      </div>

      <div class="sort-buttons">
        <button id="sortVisitDate">å…¨éƒ¨</button>
        <div style="position:relative">
          <button id="csvMainBtn">ä¿å­˜</button>
          <div class="csv-menu" id="csvMenu">
            <button id="exportCSVBtn">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            <button id="importCSVBtn">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- å³ -->
    <div class="header-right" id="statsBox">
      æ¤œç´¢çµæœï¼š0ä»¶<br>
      è¨ªå•ï¼š0<br>
      åˆ‡ç¬¦ï¼š0
    </div>

  </div>
</header><div class="container" id="output"></div>

<!-- modal -->
<div class="modal" id="detailModal">
  <div class="modal-content">
    <h2 id="modalName"></h2>
    <div>åˆ‡ç¬¦è³¼å…¥ï¼š<input type="checkbox" id="ticketCheck"></div>
    <div>è¨ªå•å±¥æ­´<span id="visitCountLabel"></span></div>
    <div id="visitList"></div>
    <label>è¨ªå•æ—¥ï¼š<input type="date" id="visitDate"></label>
    <div class="modal-buttons">
      <button id="addVisitBtn">è¿½åŠ </button>
      <button id="closeModal2">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<input type="file" id="csvFile" style="display:none">

<script>
const csvUrl="https://docs.google.com/spreadsheets/d/1VOKUKRTHUnmj5ILDyqJbdbqkePLFps-Ti8UpUfjnHeg/gviz/tq?tqx=out:csv";
let rows=[],currentId=null,searchWord="",sortVisit=true;

const $=id=>document.getElementById(id);
const storage=id=>JSON.parse(localStorage.getItem(`michinoeki_${id}`)||'{"visits":[],"ticket":false}');

fetch(csvUrl).then(r=>r.text()).then(t=>{
  Papa.parse(t,{header:true,skipEmptyLines:true,complete:r=>{
    rows=r.data;
    $("sortVisitDate").classList.remove("active");
    $("sortVisitDate").textContent = "å…¨éƒ¨";
    render();
  }});
});

$("search").oninput=()=>{
  searchWord=$("search").value.toLowerCase().trim();
  $("clearBtn").style.display=searchWord?"block":"none";
  render();
};
$("clearBtn").onclick=()=>{searchWord="";$("search").value="";render()};

$("sortVisitDate").onclick = (e) => {
  sortVisit = !sortVisit;

  if (sortVisit) {
    // è¨ªå•æ¸ˆã¿è¡¨ç¤ºä¸­ â†’ active OFF
    e.target.classList.remove("active");
    e.target.textContent = "å…¨éƒ¨";
  } else {
    // å…¨éƒ¨è¡¨ç¤ºä¸­ â†’ active ON
    e.target.classList.add("active");
    e.target.textContent = "è¨ªå•";
  }

  render();
};
$("csvMainBtn").onclick=e=>{
  e.stopPropagation();
  $("csvMenu").style.display=$("csvMenu").style.display==="block"?"none":"block";
};
document.onclick=()=>{$("csvMenu").style.display="none"};

function render(){
  let list=rows.filter(r=>{
    const hit =
      !searchWord || searchWord.split(/\s+/).some(w =>
        (r["åç§°"]||"").toLowerCase().includes(w) ||
        (r["ä½æ‰€"]||"").toLowerCase().includes(w)
      );

    if(!hit) return false;

    if(sortVisit){
      const s = storage(r.ID);
      return s.visits.length > 0;
    }

    return true;
  });

  if(sortVisit){
    list.sort((a,b)=>
      new Date(storage(b.ID).visits[0]?.date||0) -
      new Date(storage(a.ID).visits[0]?.date||0)
    );
  }

  $("output").innerHTML="";
  list.forEach(r=>{
    const s=storage(r.ID);
    const d=document.createElement("div");
    d.className="row";
d.innerHTML = `
  <div class="name">${r["åç§°"]}</div>
  <div class="address">${r["ä½æ‰€"]||""}</div>
  <div class="last-visit">
    ${s.visits.length ? `${s.visits.length}å› ${s.visits[0].date}` : ""}
  </div>
  <div class="ticket">${s.ticket ? "åˆ‡ç¬¦å…¥æ‰‹æ¸ˆ" : ""}</div>
`;

    d.querySelector(".name").onclick=()=>openModal(r);
    $("output").appendChild(d);
  });
  $("listCount").textContent = `ï¼š${list.length}ä»¶`;
  updateStats();
}

function updateStats(){
  let v=0,t=0;
  for(let k in localStorage){
    if(k.startsWith("michinoeki_")){
      const s=JSON.parse(localStorage[k]);
      if(s.visits.length)v++;
      if(s.ticket)t++;
    }
  }
  $("statsBox").innerHTML=`è¨ªå•ï¼š${v}<br>åˆ‡ç¬¦ï¼š${t}`;
}

const modal=$("detailModal");
$("closeModal2").onclick=()=>modal.style.display="none";

function openModal(r){
  currentId=r.ID;
  modal.style.display="flex";
  $("modalName").textContent=r["åç§°"];
  $("visitDate").value=new Date().toISOString().split("T")[0];
  const s=storage(currentId);
  $("ticketCheck").checked=s.ticket;
  renderVisits(s.visits);
}

$("ticketCheck").onchange=e=>{
  const s=storage(currentId);
  s.ticket=e.target.checked;
  localStorage.setItem(`michinoeki_${currentId}`,JSON.stringify(s));
  render();
};

$("addVisitBtn").onclick=()=>{
  const d=$("visitDate").value;
  if(!d)return alert("è¨ªå•æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  const s=storage(currentId);
  s.visits.unshift({date:d});
  localStorage.setItem(`michinoeki_${currentId}`,JSON.stringify(s));
  renderVisits(s.visits);
  render();
};

function renderVisits(v){
  $("visitList").innerHTML="";
  $("visitCountLabel").textContent=`ï¼š${v.length}å›`;
  v.forEach((e,i)=>{
    const div=document.createElement("div");
    div.className="visit-entry";
    const formatted = e.date.replace(/\//g, "-");
    div.innerHTML = `<div>${formatted}</div>`;
    const b=document.createElement("button");
    b.textContent="ğŸ—‘";
    b.className="delete-btn";
    b.onclick=()=>{v.splice(i,1);localStorage.setItem(`michinoeki_${currentId}`,JSON.stringify({ticket:$("ticketCheck").checked,visits:v}));renderVisits(v);render();};
    div.appendChild(b);
    $("visitList").appendChild(div);
  });
}
// ===== ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ =====
$("exportCSVBtn").onclick = () => {
  const data = [];

  for (let k in localStorage) {
    if (k.startsWith("michinoeki_")) {
      const id = k.replace("michinoeki_", "");
      const s = JSON.parse(localStorage[k]);
      data.push({
        ID: id,
        ticket: s.ticket ? 1 : 0,
        visits: s.visits.map(v => v.date).join("|")
      });
    }
  }

  const csv = Papa.unparse(data);

  const now = new Date();
  const ts =
    now.getFullYear().toString() +
    String(now.getMonth() + 1).padStart(2, "0") +
    String(now.getDate()).padStart(2, "0") +
    String(now.getHours()).padStart(2, "0") +
    String(now.getMinutes()).padStart(2, "0");

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `michinoeki_data_${ts}.csv`;
  a.click();

  URL.revokeObjectURL(url);
};
// ===== ã‚¤ãƒ³ãƒãƒ¼ãƒˆ =====
$("importCSVBtn").onclick = () => {
  $("csvFile").click();
};

$("csvFile").onchange = e => {
  const file = e.target.files[0];
  if (!file) return;

  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: r => {
      r.data.forEach(row => {
        const visits = row.visits
          ? row.visits.split("|").map(d => ({ date: d }))
          : [];

        localStorage.setItem(
          `michinoeki_${row.ID}`,
          JSON.stringify({
            ticket: row.ticket === "1",
            visits
          })
        );
      });
      render();
      alert("ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†");
    }
  });

  e.target.value = ""; // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«å†é¸æŠå¯¾ç­–
};

</script>

</body>
</html>
