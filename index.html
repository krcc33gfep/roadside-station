<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>é“ã®é§…ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ï¼ˆä¿®æ­£ç‰ˆãƒ»å®Œå…¨å‹•ä½œç‰ˆï¼‰</title>

<link href="https://fonts.googleapis.com/css2?family=M+PLUS+1+Code:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
html, body {
  background: #f0fff4;
  color: #033;
  font-family: "M PLUS 1 Code", monospace;
  margin: 0;
  overflow-x: hidden;
}
header {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 12px;
  background: #a5d6a7;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.search-wrapper {
  position: relative;
  width: 95%;
  max-width: 500px;
}
input[type="text"] {
  width: 100%;
  background: #e8f5e9;
  border: 1px solid #81c784;
  border-radius: 8px;
  padding: 8px 36px 8px 10px;
  font-size: 16px;
  box-sizing: border-box;
}
.clear-btn {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: #388e3c;
  font-size: 20px;
  cursor: pointer;
  display: none;
}
.header-bottom {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  gap: 20px;
  flex-wrap: nowrap;
  margin-top: 8px;
}
.stats-box {
  font-size: 13px;
  line-height: 1.3;
  text-align: left;
  color: #1b5e20;
  min-width: 100px;
  white-space: nowrap;
}
.sort-buttons {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  justify-content: center;
}
.sort-buttons button {
  background: #81c784;
  color: #033;
  border: none;
  border-radius: 6px;
  padding: 6px 12px;
  cursor: pointer;
  font-size: 14px;
  transition: background 0.2s;
  width: 60px;
  text-align: center;
}
.sort-buttons button.active {
  background: #4caf50;
  color: #fff;
}
.csv-menu {
  display: none;
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  background: #fff;
  border: 1px solid #81c784;
  border-radius: 8px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.25);
  overflow: hidden;
  min-width: 130px;
  margin-top: 6px;
  z-index: 10;
}
.csv-menu button {
  display: block;
  width: 100%;
  border: none;
  background: #fff;
  padding: 10px 16px;
  text-align: center;
  cursor: pointer;
}
.csv-menu button:hover {
  background: #c8e6c9;
}
.container {
  padding: 10px;
}
.row {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  padding: 10px 0;
  border-bottom: 1px solid #c8e6c9;
}
.left {
  flex: 2;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}
.right {
  flex: 1;
  text-align: right;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: flex-end;
}
.name {
  font-size: 1.3em;
  font-weight: 600;
  color: #2e7d32;
  cursor: pointer;
  margin-top: 0;
  line-height: 1.2;
}
.address {
  font-size: 0.9em;
  color: #555;
}
.last-visit {
  font-size: 0.9em;
  color: #1b5e20;
}
.ticket {
  font-size: 0.85em;
  color: #388e3c;
}
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  justify-content: center;
  align-items: center;
  z-index: 999;
}
.modal-content {
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  width: 70%;
  max-width: 800px;
  max-height: 90%;
  overflow-y: auto;
}
.visit-entry {
  border-bottom: 1px solid #ddd;
  padding: 4px 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.delete-btn {
  background: none;
  border: none;
  color: #d32f2f;
  cursor: pointer;
}
#visitDate {
  background: #e8f5e9;
  border: 1px solid #81c784;
  border-radius: 6px;
  padding: 6px;
  font-size: 15px;
  width: 160px;
}
.modal-buttons {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-top: 10px;
}
.modal-buttons button {
  flex: 1;
  max-width: 160px;
  padding: 10px;
  border: none;
  border-radius: 6px;
  color: #fff;
  cursor: pointer;
  font-size: 20px; /* â† â˜…è¿½åŠ ï¼ˆãŠå¥½ã¿ã§å¤‰æ›´ï¼‰ */
}
#addVisitBtn { background: #4caf50; }
#closeModal2 { background: #d32f2f; }
#visitList {
  max-height: calc(3 * 34px);
  overflow-y: auto;
  margin-top: 8px;
  border-top: 1px solid #c8e6c9;
  padding-top: 4px;
}
.modal-heading {
  font-size: 1.2em;
  font-weight: 600;
  color: #000;
  margin: 8px 0 6px;
}
#modalName {
  color: #2e7d32;
}
</style>
</head>

<body>
<header>
  <div class="search-wrapper">
    <input id="search" type="text" placeholder="æ¤œç´¢ï¼ˆåç§°ãƒ»ä½æ‰€ï¼‰...">
    <button id="clearBtn" class="clear-btn">&times;</button>
  </div>

  <div class="header-bottom">
    <div class="sort-buttons">
      <button id="sortVisitDate">è¨ªå•</button>
      <button id="filterTicket">åˆ‡ç¬¦</button>
      <div style="position: relative;">
        <button id="csvMainBtn">ä¿å­˜</button>
        <div class="csv-menu" id="csvMenu">
          <button id="exportCSVBtn">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <button id="importCSVBtn">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        </div>
      </div>
    </div>
    <div class="stats-box" id="statsBox">
      è¨ªå•ï¼š0<br>åˆ‡ç¬¦ï¼š0
    </div>
  </div>
</header>

<div class="container" id="output"></div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal" id="detailModal">
  <div class="modal-content">
    <h2 id="modalName"></h2>
    <div class="modal-heading">
      åˆ‡ç¬¦è³¼å…¥ï¼š<input type="checkbox" id="ticketCheck">
    </div>
    <div class="modal-heading">
      è¨ªå•å±¥æ­´<span id="visitCountLabel"></span>
    </div>
    <div id="visitList"></div>
    <label>è¨ªå•æ—¥ï¼š<input type="date" id="visitDate"></label>
    <div class="modal-buttons">
      <button id="addVisitBtn">è¿½åŠ </button>
      <button id="closeModal2">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<!-- CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆç”¨ -->
<input type="file" id="csvFile" style="display:none">

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/1VOKUKRTHUnmj5ILDyqJbdbqkePLFps-Ti8UpUfjnHeg/gviz/tq?tqx=out:csv";
let rows = [];
let currentId = null;
let currentSearch = "";
let showOnlyTicket = false;
let sortByVisitDate = false;

/* ===== CSVèª­ã¿è¾¼ã¿ ===== */
fetch(csvUrl)
  .then(r => r.text())
  .then(csvText => {
    Papa.parse(csvText, {
      header: true,
      skipEmptyLines: true,
      complete: res => { rows = res.data; renderFiltered(); }
    });
  });

/* ===== æ¤œç´¢ ===== */
const search = document.getElementById("search");
const clearBtn = document.getElementById("clearBtn");
search.addEventListener("input", () => {
  currentSearch = search.value.toLowerCase().trim();
  clearBtn.style.display = currentSearch ? "block" : "none";
  renderFiltered();
});
clearBtn.addEventListener("click", ()=>{
  search.value="";
  currentSearch="";
  clearBtn.style.display="none";
  renderFiltered();
});

/* ===== ãƒ•ã‚£ãƒ«ã‚¿ãƒ»ã‚½ãƒ¼ãƒˆ ===== */
document.getElementById("filterTicket").addEventListener("click", ()=>{
  showOnlyTicket = !showOnlyTicket;
  document.getElementById("filterTicket").classList.toggle("active", showOnlyTicket);
  renderFiltered();
});
document.getElementById("sortVisitDate").addEventListener("click", ()=>{
  sortByVisitDate = !sortByVisitDate;
  document.getElementById("sortVisitDate").classList.toggle("active", sortByVisitDate);
  renderFiltered();
});

/* ===== CSVãƒ¡ãƒ‹ãƒ¥ãƒ¼ ===== */
const csvMainBtn = document.getElementById("csvMainBtn");
const csvMenu = document.getElementById("csvMenu");
csvMainBtn.addEventListener("click", (e)=>{
  e.stopPropagation();
  csvMenu.style.display = csvMenu.style.display === "block" ? "none" : "block";
});
document.addEventListener("click", ()=> csvMenu.style.display = "none");

/* ===== CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ ===== */
document.getElementById("exportCSVBtn").addEventListener("click", () => {
  const allData = [];
  for (let key in localStorage) {
    if (key.startsWith("michinoeki_")) {
      const id = key.replace("michinoeki_", "");
      const saved = JSON.parse(localStorage.getItem(key) || "{}");
      const visits = Array.isArray(saved.visits) ? saved.visits : [];
      allData.push({ id, ticket: saved.ticket ? "1" : "0", visits });
    }
  }
  const maxVisits = Math.max(...allData.map(d => d.visits.length), 0);
  const data = allData.map(d => {
    const row = { ID: d.id, ticket: d.ticket };
    d.visits.forEach((v, i) => row[`visit${i + 1}`] = v.date || "");
    for (let i = d.visits.length; i < maxVisits; i++) row[`visit${i + 1}`] = "";
    return row;
  });
  const headers = ["ID", "ticket"];
  for (let i = 1; i <= maxVisits; i++) headers.push(`visit${i}`);
  const csv = Papa.unparse({ fields: headers, data });
  const now = new Date();
  const pad = n => n.toString().padStart(2, "0");
  const timestamp = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}${pad(now.getHours())}${pad(now.getMinutes())}`;
  const filename = `michinoeki_data_${timestamp}.csv`;
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a); URL.revokeObjectURL(url);
});

/* ===== CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ ===== */
document.getElementById("importCSVBtn").addEventListener("click", ()=> document.getElementById("csvFile").click());
document.getElementById("csvFile").addEventListener("change", (e)=>{
  const file = e.target.files[0];
  if (!file) return;
  Papa.parse(file, {
    header: true,
    complete: result => {
      result.data.forEach(row=>{
        if (!row.ID) return;
        const visits = [];
        Object.keys(row).forEach(k=>{
          if (k.startsWith("visit") && row[k]) visits.push({ date: row[k] });
        });
        visits.sort((a,b)=> new Date(b.date) - new Date(a.date));
        const saved = { ticket: row.ticket === "1", visits };
        localStorage.setItem(`michinoeki_${row.ID}`, JSON.stringify(saved));
      });
      alert("CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼");
      renderFiltered();
    }
  });
});

/* ===== è¡¨ç¤ºæ›´æ–° ===== */
function renderFiltered(){
  let filtered = rows.filter(r=>{
    const matchSearch = currentSearch
      ? currentSearch.split(/\s+/).some(keyword =>
          (r['åç§°'] || "").toLowerCase().includes(keyword) ||
          (r['ä½æ‰€'] || "").toLowerCase().includes(keyword)
        )
      : true;
    const saved = JSON.parse(localStorage.getItem(`michinoeki_${r['ID']}`) || "{}");
    const matchTicket = showOnlyTicket ? saved.ticket : true;
    return matchSearch && matchTicket;
  });

  if(sortByVisitDate){
    filtered.sort((a,b)=>{
      const aSaved = JSON.parse(localStorage.getItem(`michinoeki_${a['ID']}`) || "{}");
      const bSaved = JSON.parse(localStorage.getItem(`michinoeki_${b['ID']}`) || "{}");
      return new Date(bSaved.visits?.[0]?.date || 0) - new Date(aSaved.visits?.[0]?.date || 0);
    });
  }

  const out = document.getElementById("output");
  out.innerHTML = "";
  filtered.forEach(r=>{
    const id=r['ID'];
    const saved=JSON.parse(localStorage.getItem(`michinoeki_${id}`) || "{}");
    const visits=saved.visits||[];
    const visitCount=visits.length;
    const lastVisit=visits?.[0]?.date||"";
    const ticketLabel=saved.ticket?"åˆ‡ç¬¦è³¼å…¥æ¸ˆ":"";

    const div = document.createElement("div");
    div.className = "row";
    div.innerHTML = `
      <div class="left">
        <div class="name">${r['åç§°'] || "ï¼ˆåç§°ä¸æ˜ï¼‰"}</div>
        <div class="address">${r['ä½æ‰€'] || ""}</div>
      </div>
      <div class="right">
        <div class="last-visit">${visitCount ? `${visitCount}å› ${lastVisit}` : ""}</div>
        <div class="ticket">${ticketLabel}</div>
      </div>
    `;
    div.querySelector(".name").addEventListener("click", () => openDetail(r));
    out.appendChild(div);
  });

  updateStats();
}

/* ===== çµ±è¨ˆæ›´æ–° ===== */
function updateStats(){
  let visitedCount = 0;
  let purchasedCount = 0;
  for (let key in localStorage){
    if (key.startsWith("michinoeki_")){
      const saved = JSON.parse(localStorage.getItem(key) || "{}");
      if (saved.visits && saved.visits.length > 0) visitedCount++;
      if (saved.ticket) purchasedCount++;
    }
  }
  document.getElementById("statsBox").innerHTML = `è¨ªå•ï¼š${visitedCount}<br>åˆ‡ç¬¦ï¼š${purchasedCount}`;
}

/* ===== ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ ===== */
const modal=document.getElementById("detailModal");
document.getElementById("closeModal2").addEventListener("click",()=>modal.style.display="none");

function openDetail(r){
  currentId=r['ID'];
  modal.style.display="flex";
  document.getElementById("modalName").textContent=r['åç§°'];
  const today = new Date().toISOString().split("T")[0];
  document.getElementById("visitDate").value = today;
  const saved=JSON.parse(localStorage.getItem(`michinoeki_${currentId}`)||'{"visits":[],"ticket":false}');
  document.getElementById("ticketCheck").checked=saved.ticket;
  renderVisits(saved.visits);
}

document.getElementById("ticketCheck").addEventListener("change",e=>{
  if(!currentId)return;
  const saved=JSON.parse(localStorage.getItem(`michinoeki_${currentId}`)||'{"visits":[],"ticket":false}');
  saved.ticket=e.target.checked;
  localStorage.setItem(`michinoeki_${currentId}`,JSON.stringify(saved));
  renderFiltered();
});

document.getElementById("addVisitBtn").addEventListener("click",()=>{
  const date=document.getElementById("visitDate").value;
  if(!date)return alert("è¨ªå•æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  const key=`michinoeki_${currentId}`;
  let saved=JSON.parse(localStorage.getItem(key)||'{"visits":[],"ticket":false}');
  saved.visits.push({date});
  saved.visits.sort((a,b)=>new Date(b.date)-new Date(a.date));
  localStorage.setItem(key,JSON.stringify(saved));
  renderVisits(saved.visits);
  renderFiltered();
});

function deleteVisit(i){
  const key=`michinoeki_${currentId}`;
  let saved=JSON.parse(localStorage.getItem(key)||'{"visits":[],"ticket":false}');
  saved.visits.splice(i,1);
  localStorage.setItem(key,JSON.stringify(saved));
  renderVisits(saved.visits);
  renderFiltered();
}

function renderVisits(visits){
  const list=document.getElementById("visitList");
  const countLabel=document.getElementById("visitCountLabel");
  if(!visits.length){list.innerHTML="";countLabel.textContent="ï¼š0å›";return;}

  list.innerHTML="";
  visits.forEach((v,i)=>{
    const dateObj=new Date(v.date);
    const y=dateObj.getFullYear();
    const m=String(dateObj.getMonth()+1).padStart(2,"0");
    const d=String(dateObj.getDate()).padStart(2,"0");
    const formatted=`${y}-${m}-${d}`;
    const entry=document.createElement("div");
    entry.className="visit-entry";
    entry.innerHTML=`<div>${formatted}</div>`;
    const btn=document.createElement("button");
    btn.className="delete-btn";
    btn.textContent="ğŸ—‘";
    btn.addEventListener("click",()=>deleteVisit(i));
    entry.appendChild(btn);
    list.appendChild(entry);
  });
  countLabel.textContent=`ï¼š${visits.length}å›`;
}
</script>
</body>
</html>
