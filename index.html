<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>道の駅ビューワー（修正版・完全動作版）</title>

<link href="https://fonts.googleapis.com/css2?family=M+PLUS+1+Code:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
html,body{
  margin:0;
  background:#f0fff4;
  color:#033;
  font-family:"M PLUS 1 Code",monospace;
  overflow-x:hidden;
}
header{
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:12px;
  background:#a5d6a7;
  box-shadow:0 2px 4px rgba(0,0,0,.1);
}

/* ===== 検索 ===== */
.search-wrapper{
  position:relative;
  width:95%;
  max-width:500px;
}
input[type="text"]{
  width:100%;
  background:#e8f5e9;
  border:1px solid #81c784;
  border-radius:8px;
  padding:8px 36px 8px 10px;
  font-size:16px;
  box-sizing:border-box;
}
.clear-btn{
  position:absolute;
  right:8px;
  top:50%;
  transform:translateY(-50%);
  background:none;
  border:none;
  font-size:20px;
  color:#388e3c;
  cursor:pointer;
  display:none;
}

/* ★ 検索件数表示（追加） */
.search-count{
  position:absolute;
  right:-120px;
  top:50%;
  transform:translateY(-50%);
  font-size:15px;
  color:#1b5e20;
  white-space:nowrap;
}

/* ===== ヘッダー下 ===== */
.header-bottom{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:20px;
  width:100%;
  margin-top:8px;
}
.sort-buttons{
  display:flex;
  gap:8px;
}
.sort-buttons button{
  background:#81c784;
  border:none;
  border-radius:6px;
  padding:6px 30px;
  font-size:16px;
  cursor:pointer;
}
.sort-buttons button.active{
  background:#4caf50;
  color:#fff;
}
.stats-box{
  font-size:15px;
  color:#1b5e20;
  white-space:nowrap;
  line-height:1.0;
}

/* ===== 一覧 ===== */
.container{padding:10px}
.row{
  display:grid;
  grid-template-columns:1fr auto;
  grid-template-rows:auto auto;
  column-gap:12px;
  padding:10px 0;
  border-bottom:1px solid #c8e6c9;
}
.name{
  font-size:1.3em;
  font-weight:600;
  color:#2e7d32;
  cursor:pointer;
}
.address{font-size:.9em;color:#555}
.last-visit{font-size:.9em;text-align:right}
.ticket{font-size:.85em;text-align:right;color:#388e3c}

/* ===== modal ===== */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  justify-content:center;
  align-items:center;
  z-index:999;
}
.modal-content{
  background:#fff;
  padding:6px 20px 20px;
  border-radius:10px;
  width:70%;
  max-width:800px;
}
.visit-entry{
  display:flex;
  justify-content:space-between;
  border-bottom:1px solid #ddd;
}
.delete-btn{
  border:none;
  background:none;
  cursor:pointer;
  color:#d32f2f;
}
#visitList{
  max-height:calc(3 * 34px);
  overflow-y:auto;
  border-top:1px solid #c8e6c9;
  margin-top:6px;
}
.modal-buttons{
  display:flex;
  gap:10px;
  margin-top:10px;
}
.modal-buttons button{
  flex:1;
  padding:10px;
  font-size:20px;
  border:none;
  border-radius:6px;
  color:#fff;
}
#addVisitBtn{background:#4caf50}
#closeModal2{background:#d32f2f}
</style>
</head>

<body>

<header>
  <div class="search-wrapper">
    <input id="search" type="text" placeholder="検索（名称・住所）...">
    <button id="clearBtn" class="clear-btn">&times;</button>
    <div class="search-count" id="searchCount">検索結果：0件</div>
  </div>

  <div class="header-bottom">
    <div class="sort-buttons">
      <button id="sortVisitDate">訪問</button>
    </div>
    <div class="stats-box" id="statsBox">訪問：0<br>切符：0</div>
  </div>
</header>

<div class="container" id="output"></div>

<script>
const csvUrl="https://docs.google.com/spreadsheets/d/1VOKUKRTHUnmj5ILDyqJbdbqkePLFps-Ti8UpUfjnHeg/gviz/tq?tqx=out:csv";
let rows=[],searchWord="",sortVisit=false;
const $=id=>document.getElementById(id);
const storage=id=>JSON.parse(localStorage.getItem(`michinoeki_${id}`)||'{"visits":[],"ticket":false}');

fetch(csvUrl).then(r=>r.text()).then(t=>{
  Papa.parse(t,{header:true,skipEmptyLines:true,complete:r=>{
    rows=r.data;render();
  }});
});

$("search").oninput=()=>{
  searchWord=$("search").value.toLowerCase().trim();
  $("clearBtn").style.display=searchWord?"block":"none";
  render();
};
$("clearBtn").onclick=()=>{searchWord="";$("search").value="";render()};

function render(){
  let list=rows.filter(r=>
    !searchWord || searchWord.split(/\s+/).some(w=>
      (r["名称"]||"").toLowerCase().includes(w) ||
      (r["住所"]||"").toLowerCase().includes(w)
    )
  );

  $("searchCount").textContent=`検索結果：${list.length}件`;

  $("output").innerHTML="";
  list.forEach(r=>{
    const s=storage(r.ID);
    const d=document.createElement("div");
    d.className="row";
    d.innerHTML=`
      <div class="name">${r["名称"]}</div>
      <div class="address">${r["住所"]||""}</div>
      <div class="last-visit">${s.visits.length?`${s.visits.length}回 ${s.visits[0].date}`:""}</div>
      <div class="ticket">${s.ticket?"切符購入済":""}</div>
    `;
    $("output").appendChild(d);
  });

  let v=0,t=0;
  for(let k in localStorage){
    if(k.startsWith("michinoeki_")){
      const s=JSON.parse(localStorage[k]);
      if(s.visits.length)v++;
      if(s.ticket)t++;
    }
  }
  $("statsBox").innerHTML=`訪問：${v}<br>切符：${t}`;
}
</script>

</body>
</html>
