<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>é“ã®é§…ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ï¼ˆCSVçµ±åˆãƒœã‚¿ãƒ³ç‰ˆï¼‰</title>

<link href="https://fonts.googleapis.com/css2?family=M+PLUS+1+Code:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  html, body {
    background: #f0fff4;
    color: #033;
    font-family: "M PLUS 1 Code", monospace;
    margin: 0;
  }

  header {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 12px;
    background: #a5d6a7;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .search-wrapper {
    position: relative;
    width: 95%;
    max-width: 500px;
  }

  input[type="text"] {
    width: 100%;
    background: #e8f5e9;
    color: #033;
    border: 1px solid #81c784;
    border-radius: 8px;
    padding: 8px 36px 8px 10px;
    font-size: 16px;
    box-sizing: border-box;
  }

  .clear-btn {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #388e3c;
    font-size: 20px;
    cursor: pointer;
    display: none;
  }

  .sort-buttons {
    display: flex;
    gap: 8px;
    margin-top: 10px;
    flex-wrap: wrap;
    justify-content: center;
  }

  .sort-buttons button {
    background: #81c784;
    color: #033;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
  }

  .sort-buttons button:hover { background: #66bb6a; }
  .sort-buttons button.active { background: #4caf50; color: #fff; }

  .csv-menu {
    display: none;
    position: absolute;
    background: #fff;
    border: 1px solid #81c784;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    overflow: hidden;
    margin-top: 4px;
  }

  .csv-menu button {
    display: block;
    width: 100%;
    border: none;
    background: #fff;
    color: #033;
    padding: 8px 16px;
    text-align: left;
    cursor: pointer;
  }

  .csv-menu button:hover {
    background: #c8e6c9;
  }

  .container { padding: 10px; }

  .row {
    display: flex; justify-content: space-between; align-items: flex-end;
    padding: 10px 0; border-bottom: 1px solid #c8e6c9;
  }

  .left { flex: 2; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
  .right { flex: 1; text-align: right; display: flex; flex-direction: column; }

  .name { font-size: 1.3em; font-weight: 600; color: #2e7d32; cursor: pointer; }
  .address { font-size: 0.9em; color: #555; }
  .last-visit { font-size: 0.9em; color: #1b5e20; }
  .ticket { font-size: 0.85em; color: #388e3c; }

  /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.4); justify-content: center; align-items: center;
  }

  .modal-content {
    background: #fff; color: #111; padding: 20px; border-radius: 10px;
    width: 70%; max-width: 800px; max-height: 90%; overflow-y: auto;
  }

  .close-btn { float: right; background: none; border: none; font-size: 20px; cursor: pointer; }

  .visit-entry {
    border-bottom: 1px solid #ddd; padding: 4px 0;
    display: flex; justify-content: space-between; align-items: center;
  }

  .delete-btn { background: none; border: none; color: #d32f2f; font-size: 16px; cursor: pointer; }

  #ticketCheck { transform: scale(1.5); accent-color: #4caf50; cursor: pointer; }
  label[for="ticketCheck"] { display: flex; justify-content: center; align-items: center; gap: 8px; font-size: 1.1em; margin: 10px 0; }

  button.add-btn {
    margin: 12px auto 0; display: block; width: 50%;
    background: #4caf50; color: white; border: none; border-radius: 6px;
    padding: 8px 10px; cursor: pointer; font-size: 15px;
  }

  button.add-btn:hover { background: #388e3c; }

  #visitCountLabel { color: #2e7d32; font-weight: 500; margin-left: 4px; }
</style>
</head>
<body>

<header>
  <div class="search-wrapper">
    <input id="search" type="text" placeholder="æ¤œç´¢ï¼ˆåç§°ãƒ»ä½æ‰€ï¼‰...">
    <button id="clearBtn" class="clear-btn">&times;</button>
  </div>

  <div class="sort-buttons">
    <button id="filterTicket">è³¼å…¥æ¸ˆã¿</button>
    <button id="sortVisitDate">è¨ªå•æ—¥é †</button>
    <div style="position: relative;">
      <button id="csvMainBtn">CSV</button>
      <div class="csv-menu" id="csvMenu">
        <button id="exportCSVBtn">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <button id="importCSVBtn">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
      </div>
    </div>
    <input type="file" id="csvFile" accept=".csv" style="display:none;">
  </div>
</header>

<div class="container" id="output"></div>

<!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal" id="detailModal">
  <div class="modal-content">
    <button class="close-btn" id="closeModal">&times;</button>
    <h2 id="modalName"></h2>

    <label><input type="checkbox" id="ticketCheck"> åˆ‡ç¬¦è³¼å…¥æ¸ˆ</label>

    <h3>è¨ªå•å±¥æ­´<span id="visitCountLabel"></span></h3>
    <div id="visitList"></div>

    <label>è¨ªå•æ—¥ï¼š<input type="date" id="visitDate"></label>
    <button class="add-btn" id="addVisitBtn">è¿½åŠ </button>
  </div>
</div>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/1VOKUKRTHUnmj5ILDyqJbdbqkePLFps-Ti8UpUfjnHeg/gviz/tq?tqx=out:csv";
let rows = [];
let currentId = null;
let currentSearch = "";
let showOnlyTicket = false;
let sortByVisitDate = false;

/* ===== é§…ãƒ‡ãƒ¼ã‚¿èª­è¾¼ ===== */
fetch(csvUrl)
  .then(r => r.text())
  .then(csvText => {
    Papa.parse(csvText, {
      header: true,
      skipEmptyLines: true,
      complete: res => { rows = res.data; renderFiltered(); }
    });
  });

/* ===== æ¤œç´¢ ===== */
const search = document.getElementById("search");
const clearBtn = document.getElementById("clearBtn");
search.addEventListener("input", () => {
  currentSearch = search.value.toLowerCase().trim();
  clearBtn.style.display = currentSearch ? "block" : "none";
  renderFiltered();
});
clearBtn.addEventListener("click", ()=>{ search.value=""; currentSearch=""; clearBtn.style.display="none"; renderFiltered(); });

/* ===== ãƒ•ã‚£ãƒ«ã‚¿ãƒ»ã‚½ãƒ¼ãƒˆ ===== */
document.getElementById("filterTicket").addEventListener("click", ()=>{
  showOnlyTicket = !showOnlyTicket;
  document.getElementById("filterTicket").classList.toggle("active", showOnlyTicket);
  renderFiltered();
});
document.getElementById("sortVisitDate").addEventListener("click", ()=>{
  sortByVisitDate = !sortByVisitDate;
  document.getElementById("sortVisitDate").classList.toggle("active", sortByVisitDate);
  renderFiltered();
});

/* ===== CSVãƒ¡ãƒ‹ãƒ¥ãƒ¼ ===== */
const csvMainBtn = document.getElementById("csvMainBtn");
const csvMenu = document.getElementById("csvMenu");

csvMainBtn.addEventListener("click", (e)=>{
  e.stopPropagation();
  csvMenu.style.display = csvMenu.style.display === "block" ? "none" : "block";
});

document.addEventListener("click", ()=> csvMenu.style.display = "none");

/* ===== ä¸€è¦§æç”» ===== */
function renderFiltered(){
  let filtered = rows.filter(r=>{
    const matchSearch = currentSearch
      ? (r['åç§°']||"").toLowerCase().includes(currentSearch) || (r['ä½æ‰€']||"").toLowerCase().includes(currentSearch)
      : true;
    const saved = JSON.parse(localStorage.getItem(`michinoeki_${r['ID']}`) || "{}");
    const matchTicket = showOnlyTicket ? saved.ticket : true;
    return matchSearch && matchTicket;
  });

  if(sortByVisitDate){
    filtered.sort((a,b)=>{
      const aSaved = JSON.parse(localStorage.getItem(`michinoeki_${a['ID']}`) || "{}");
      const bSaved = JSON.parse(localStorage.getItem(`michinoeki_${b['ID']}`) || "{}");
      return new Date(bSaved.visits?.[0]?.date || 0) - new Date(aSaved.visits?.[0]?.date || 0);
    });
  }

  const out = document.getElementById("output");
  out.innerHTML = "";
  filtered.forEach(r=>{
    const id=r['ID'];
    const saved=JSON.parse(localStorage.getItem(`michinoeki_${id}`) || "{}");
    const visits=saved.visits||[];
    const visitCount=visits.length;
    const lastVisit=visits?.[0]?.date||"";
    const ticketLabel=saved.ticket?"åˆ‡ç¬¦è³¼å…¥æ¸ˆ":"";
    const div=document.createElement("div");
    div.className="row";
    div.innerHTML=`
      <div class="left">
        <div class="name">${r['åç§°']||"ï¼ˆåç§°ä¸æ˜ï¼‰"}</div>
        <div class="address">${r['ä½æ‰€']||""}</div>
      </div>
      <div class="right">
        <div class="last-visit">${visitCount?`${visitCount}å› ${lastVisit}`:""}</div>
        <div class="ticket">${ticketLabel}</div>
      </div>`;
    div.querySelector(".name").addEventListener("click",()=>openDetail(r));
    out.appendChild(div);
  });
}

/* ===== è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
const modal=document.getElementById("detailModal");
document.getElementById("closeModal").addEventListener("click",()=>modal.style.display="none");

function openDetail(r){
  currentId=r['ID'];
  modal.style.display="flex";
  document.getElementById("modalName").textContent=r['åç§°'];
  const saved=JSON.parse(localStorage.getItem(`michinoeki_${currentId}`)||'{"visits":[],"ticket":false}');
  document.getElementById("ticketCheck").checked=saved.ticket;
  renderVisits(saved.visits);
}

document.getElementById("ticketCheck").addEventListener("change",e=>{
  if(!currentId)return;
  const saved=JSON.parse(localStorage.getItem(`michinoeki_${currentId}`)||'{"visits":[],"ticket":false}');
  saved.ticket=e.target.checked;
  localStorage.setItem(`michinoeki_${currentId}`,JSON.stringify(saved));
  renderFiltered();
});

/* ===== è¨ªå•å±¥æ­´ ===== */
document.getElementById("addVisitBtn").addEventListener("click",()=>{
  const date=document.getElementById("visitDate").value;
  if(!date)return alert("è¨ªå•æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  const key=`michinoeki_${currentId}`;
  let saved=JSON.parse(localStorage.getItem(key)||'{"visits":[],"ticket":false}');
  saved.visits.push({date});
  saved.visits.sort((a,b)=>new Date(b.date)-new Date(a.date));
  localStorage.setItem(key,JSON.stringify(saved));
  renderVisits(saved.visits);
  renderFiltered();
  document.getElementById("visitDate").value="";
});

function deleteVisit(i){
  const key=`michinoeki_${currentId}`;
  let saved=JSON.parse(localStorage.getItem(key)||'{"visits":[],"ticket":false}');
  saved.visits.splice(i,1);
  localStorage.setItem(key,JSON.stringify(saved));
  renderVisits(saved.visits);
  renderFiltered();
}

function renderVisits(visits){
  const list=document.getElementById("visitList");
  const countLabel=document.getElementById("visitCountLabel");
  if(!visits.length){list.innerHTML="";countLabel.textContent="ï¼š0å›";return;}
  list.innerHTML=visits.map((v,i)=>`<div class="visit-entry"><div>${v.date}</div><button class="delete-btn" onclick="deleteVisit(${i})">ğŸ—‘</button></div>`).join("");
  countLabel.textContent=`ï¼š${visits.length}å›`;
}

/* ===== CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ ===== */
document.getElementById("exportCSVBtn").addEventListener("click",()=>{
  const rows=[["ID","è¨ªå•å›æ•°","åˆ‡ç¬¦è³¼å…¥æ¸ˆ"]];
  let max=0;const data=[];
  for(let i=0;i<localStorage.length;i++){
    const key=localStorage.key(i);
    if(!key.startsWith("michinoeki_"))continue;
    const id=key.replace("michinoeki_","");
    const saved=JSON.parse(localStorage.getItem(key));
    const visits=(saved.visits||[]).slice().sort((a,b)=>new Date(b.date)-new Date(a.date));
    const ticket=saved.ticket?"â—‹":"";
    const dates=visits.map(v=>v.date);
    data.push([id,visits.length,ticket,...dates]);
    if(visits.length>max)max=visits.length;
  }
  for(let i=1;i<=max;i++)rows[0].push(`è¨ªå•æ—¥${i}`);
  data.forEach(r=>rows.push(r));
  const csv=rows.map(r=>r.join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="michinoeki_data_full.csv";
  a.click();
});

/* ===== CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ ===== */
const csvFile=document.getElementById("csvFile");
document.getElementById("importCSVBtn").addEventListener("click",()=>csvFile.click());
csvFile.addEventListener("change",e=>{
  const file=e.target.files[0];if(!file)return;
  Papa.parse(file,{header:true,complete:res=>{
    res.data.forEach(r=>{
      const id=r["ID"];if(!id)return;
      const ticket=r["åˆ‡ç¬¦è³¼å…¥æ¸ˆ"]==="â—‹";
      const visits=[];
      Object.keys(r).forEach(k=>{if(k.startsWith("è¨ªå•æ—¥")&&r[k])visits.push({date:r[k]});});
      visits.sort((a,b)=>new Date(b.date)-new Date(a.date));
      localStorage.setItem(`michinoeki_${id}`,JSON.stringify({visits,ticket}));
    });
    alert("CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚");
    location.reload();
  }});
});
</script>
</body>
</html>
