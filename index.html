<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>道の駅ビューワー</title>

<link href="https://fonts.googleapis.com/css2?family=M+PLUS+1+Code:wght@400;500&display=swap" rel="stylesheet">

<style>
body {
  margin: 0;
  font-family: "M PLUS 1 Code", sans-serif;
  background: #b9ddb3;
}

header {
  padding: 15px;
  background: #b9ddb3;
}

.search-row {
  display: flex;
  align-items: center;
  gap: 10px;
}

#searchInput {
  width: 66%;
  padding: 14px;
  font-size: 16px;
  border-radius: 18px;
  border: none;
}

.result-count {
  flex: 1;
  text-align: right;
  font-size: 18px;
  font-weight: bold;
}

.button-row {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: 12px;
}

button {
  flex: 1;
  padding: 14px 0;
  font-size: 18px;
  border: none;
  border-radius: 14px;
  background: #9ed18b;
  font-weight: bold;
}

button.primary {
  background: #6fb25c;
  color: #fff;
}

.counter {
  margin-left: auto;
  font-size: 16px;
  line-height: 1.4;
}

main {
  background: #fff;
  padding: 10px;
  min-height: 100vh;
}

.station {
  border-bottom: 1px solid #ddd;
  padding: 10px 0;
}

.station-name {
  font-weight: bold;
}
</style>
</head>

<body>

<header>
  <div class="search-row">
    <input type="text" id="searchInput" placeholder="検索（名称・住所）…">
    <div id="resultCount" class="result-count">0件</div>
  </div>

  <div class="button-row">
    <button id="toggleBtn" class="primary">全部</button>
    <button id="saveBtn">保存</button>

    <div class="counter">
      訪問：<span id="visitCount">0</span><br>
      切符：<span id="ticketCount">0</span>
    </div>
  </div>
</header>

<main id="stationList"></main>

<script>
/* ======================
   データ（既存想定）
====================== */
let stations = JSON.parse(localStorage.getItem("stations") || "[]");

/* ======================
   状態
====================== */
let showAllMode = false;

/* ======================
   初期表示：訪問済み
====================== */
document.addEventListener("DOMContentLoaded", () => {
  renderStations(getVisitedSorted());
});

/* ======================
   検索
====================== */
document.getElementById("searchInput").addEventListener("input", () => {
  applyFilter();
});

/* ======================
   全部／訪問 トグル
====================== */
document.getElementById("toggleBtn").addEventListener("click", () => {
  showAllMode = !showAllMode;

  if (showAllMode) {
    toggleBtn.textContent = "訪問";
    applyFilter();
  } else {
    toggleBtn.textContent = "全部";
    applyFilter();
  }
});

/* ======================
   保存
====================== */
document.getElementById("saveBtn").addEventListener("click", () => {
  localStorage.setItem("stations", JSON.stringify(stations));
  alert("保存しました");
});

/* ======================
   フィルタ適用
====================== */
function applyFilter() {
  const keyword = searchInput.value.trim();

  let baseList = showAllMode
    ? getAllStations()
    : getVisitedSorted();

  let filtered = baseList.filter(s =>
    s.name.includes(keyword) || s.address.includes(keyword)
  );

  renderStations(filtered);
}

/* ======================
   データ取得
====================== */
function getAllStations() {
  return [...stations];
}

function getVisitedSorted() {
  return stations
    .filter(s => s.visits && s.visits.length > 0)
    .sort((a, b) => {
      const da = new Date(a.visits[a.visits.length - 1]);
      const db = new Date(b.visits[b.visits.length - 1]);
      return db - da;
    });
}

/* ======================
   描画
====================== */
function renderStations(list) {
  const container = document.getElementById("stationList");
  container.innerHTML = "";

  list.forEach(s => {
    const div = document.createElement("div");
    div.className = "station";
    div.innerHTML = `
      <div class="station-name">${s.name}</div>
      <div>${s.address}</div>
    `;
    container.appendChild(div);
  });

  document.getElementById("resultCount").textContent = `${list.length}件`;
  updateCounters();
}

/* ======================
   カウンター
====================== */
function updateCounters() {
  const visited = stations.filter(s => s.visits && s.visits.length > 0);
  const tickets = stations.filter(s => s.ticket);

  document.getElementById("visitCount").textContent = visited.length;
  document.getElementById("ticketCount").textContent = tickets.length;
}
</script>

</body>
</html>
